# LangChain_微调ChatGPT提示词_RAG模型应用_agent_生成式AI - P29：5——基于文档的问答 - 吴恩达大模型 - BV1gLeueWE5N

![](img/a79e11877c93e78d6e0286c3c4597b94_0.png)

人们构建的最常见复杂应用之一。

![](img/a79e11877c93e78d6e0286c3c4597b94_2.png)

使用llm是一个可回答文档内或关于文档问题的系统，给定一段文本可能来自PDF文件或网页，或公司内部文档库，你能用nlm回答关于这些文档内容的问题吗，帮助用户深入了解并获取所需信息，这非常强大。

因为它开始将语言模型与它们未受过训练的数据结合起来，这使得它们更加灵活和适应您的用例，这也非常令人兴奋，因为我们将开始超越语言模型，提示和输出解析器，并开始引入链接链的一些关键组件。

如嵌入模型和向量存储，如安德鲁提到的，这是我们拥有的最受欢迎的链之一，所以，我希望你兴奋，实际上，嵌入和向量存储是现代最强大的技术之一，所以如果你还没有见过它们，它们非常值得学习，那么让我们深入。

让我们开始，我们将开始导入环境变量，我们现在总是这样做。

![](img/a79e11877c93e78d6e0286c3c4597b94_4.png)

我们将导入一些在构建此链时将帮助我们，我们将导入检索qa链，这将对一些文档进行检索，或导入，我们最喜欢的聊天openai语言模型，我们将导入一个文档加载器，这将用于加载一些专有数据。

我们将与语言模型结合，在这种情况下，它将在csv中，因此我们将导入csv加载器，最后我们将导入一个向量存储，有许多不同类型的向量存储，我们稍后将涵盖它们的确切含义。



![](img/a79e11877c93e78d6e0286c3c4597b94_6.png)

但我们将从docker ray内存搜索向量存储开始，这真的很棒，因为它是一个内存向量存储。

![](img/a79e11877c93e78d6e0286c3c4597b94_8.png)

并且不需要连接到任何外部数据库，这使得它非常容易开始，我们还将导入。

![](img/a79e11877c93e78d6e0286c3c4597b94_10.png)

显示和markdown，用于在jupyter笔记本中显示信息的常用工具，我们提供了一个户外服装的csv，我们将与语言模型结合，在这里我们将初始化一个加载器。



![](img/a79e11877c93e78d6e0286c3c4597b94_12.png)

使用此文件的路径初始化csv加载器，接下来我们将导入一个索引。

![](img/a79e11877c93e78d6e0286c3c4597b94_14.png)

向量存储索引创建器。

![](img/a79e11877c93e78d6e0286c3c4597b94_16.png)

这将帮助我们非常容易地创建一个向量存储，我们将导入，显示和markdown，用于在jupyter笔记本中显示信息的常用工具，如下面所示，只需几行代码即可创建，创建它，我们将指定两件事，首先。

我们将指定向量存储类，如前所述。

![](img/a79e11877c93e78d6e0286c3c4597b94_18.png)

我们将使用此向量存储，因为它特别容易入门。

![](img/a79e11877c93e78d6e0286c3c4597b94_20.png)

创建后，我将从加载器调用，接受文档加载器列表。

![](img/a79e11877c93e78d6e0286c3c4597b94_22.png)

我们只关心一个加载器，这就是传入的内容。

![](img/a79e11877c93e78d6e0286c3c4597b94_24.png)

现已创建，可开始提问。

![](img/a79e11877c93e78d6e0286c3c4597b94_26.png)

将解释内部发生了什么，现在别担心这个。

![](img/a79e11877c93e78d6e0286c3c4597b94_28.png)

现在从查询开始，使用索引查询创建响应，再次传入查询。

![](img/a79e11877c93e78d6e0286c3c4597b94_30.png)

![](img/a79e11877c93e78d6e0286c3c4597b94_31.png)

现在先不解释内部情况。

![](img/a79e11877c93e78d6e0286c3c4597b94_33.png)

等待响应，完成后。

![](img/a79e11877c93e78d6e0286c3c4597b94_35.png)

现在可查看返回内容，返回Markdown表格，含防晒衬衫名和描述，语言模型提供小结。

![](img/a79e11877c93e78d6e0286c3c4597b94_37.png)

已过文档问答方法，但内部究竟如何？

![](img/a79e11877c93e78d6e0286c3c4597b94_39.png)

先思考总体思路，想用语言模型结合文档，存在关键问题，语言模型一次只能检查几千个单词。

![](img/a79e11877c93e78d6e0286c3c4597b94_41.png)

所以如果我们有非常大的文档，如何让语言模型回答文档中所有内容的问题，这时嵌入和向量存储开始发挥作用。

![](img/a79e11877c93e78d6e0286c3c4597b94_43.png)

让我们谈谈嵌入，嵌入，为文本片段创建数值表示。

![](img/a79e11877c93e78d6e0286c3c4597b94_45.png)

该数值表示捕获了文本片段的语义含义，它已被运行过，具有相似内容的文本片段，将有相似向量，这让我们能在向量空间比较文本片段，在示例下，我们有3个句子，前两个关于宠物很好。



![](img/a79e11877c93e78d6e0286c3c4597b94_47.png)

第三个关于汽车，若看数值空间表示，当我们比较文本片段的2个向量，对应于关于宠物的句子。

![](img/a79e11877c93e78d6e0286c3c4597b94_49.png)

它们非常相似很好，若与谈论汽车的相比。

![](img/a79e11877c93e78d6e0286c3c4597b94_51.png)

它们完全不同，这将使我们容易找出哪些文本相似。

![](img/a79e11877c93e78d6e0286c3c4597b94_53.png)

这将非常有用，因为我们考虑包含哪些文本。

![](img/a79e11877c93e78d6e0286c3c4597b94_55.png)

当传递给语言模型回答问题时，接下来要讲的组件是向量数据库。

![](img/a79e11877c93e78d6e0286c3c4597b94_57.png)

向量数据库是存储之前步骤中创建的向量表示的一种方式。

![](img/a79e11877c93e78d6e0286c3c4597b94_59.png)

我们创建向量数据库的方式是。

![](img/a79e11877c93e78d6e0286c3c4597b94_61.png)

用来自入站文档的文本块填充它，当我们得到一个大的入站文档时，我们首先将其拆分为较小的块，这有助于创建比原始文档更小的文本块，这很有用，因为我们可能无法将整个文档传递给语言模型。



![](img/a79e11877c93e78d6e0286c3c4597b94_63.png)

因此，我们想创建这些小块，以便我们只能将最相关的传递给语言模型。

![](img/a79e11877c93e78d6e0286c3c4597b94_65.png)

然后，我们为这些块创建嵌入。

![](img/a79e11877c93e78d6e0286c3c4597b94_67.png)

然后将它们存储在向量数据库中，这就是创建索引时发生的情况。

![](img/a79e11877c93e78d6e0286c3c4597b94_69.png)

现在我们已经有了这个索引，我们可以在运行时使用它，找到与入站查询最相关的文本块。

![](img/a79e11877c93e78d6e0286c3c4597b94_71.png)

当查询进来时，我们首先为该查询创建嵌入。

![](img/a79e11877c93e78d6e0286c3c4597b94_73.png)

然后我们将其与向量数据库中的所有向量进行比较。

![](img/a79e11877c93e78d6e0286c3c4597b94_75.png)

并选择最相似的n个，这些然后被返回，我们可以将它们放入提示中传递给语言模型以获取最终答案。

![](img/a79e11877c93e78d6e0286c3c4597b94_77.png)

因此，上面我们创建了这个链条，只有几行代码，非常适合快速开始，但现在让我们更详细地做，并了解底层到底发生了什么。



![](img/a79e11877c93e78d6e0286c3c4597b94_79.png)

第一步与上面类似，我们将创建一个文档加载器，从包含所有产品描述的csv中加载，我们想回答的问题。

![](img/a79e11877c93e78d6e0286c3c4597b94_81.png)

然后，我们可以从这个文档加载器中加载文档。

![](img/a79e11877c93e78d6e0286c3c4597b94_83.png)

如果我们查看单个文档，我们可以看到每个文档对应csv中的一个产品，之前我们讨论了创建块，因为这些文档已经很小，实际上我们不需要在这里做任何切块。



![](img/a79e11877c93e78d6e0286c3c4597b94_85.png)

因此，我们可以直接创建嵌入。

![](img/a79e11877c93e78d6e0286c3c4597b94_87.png)

要创建嵌入，我们将使用open eyes的嵌入类，我们可以导入它并在这里初始化它，如果我们想看看这些嵌入做了什么，实际上，我们可以看看当我们嵌入特定文本时会发生什么，让我们使用嵌入查询方法在嵌入对象上。

为特定文本创建嵌入，在这种情况下，句子'hi'，我的名字是哈里森。

![](img/a79e11877c93e78d6e0286c3c4597b94_89.png)

看看这个嵌入，有超过一千个不同元素。

![](img/a79e11877c93e78d6e0286c3c4597b94_91.png)

每个元素是一个数值，结合这些，形成文本的整体数值表示。

![](img/a79e11877c93e78d6e0286c3c4597b94_93.png)

要为加载的所有文本创建嵌入。

![](img/a79e11877c93e78d6e0286c3c4597b94_95.png)

然后将其存储在向量存储中，可以使用向量存储的from_documents方法。

![](img/a79e11877c93e78d6e0286c3c4597b94_97.png)

该方法接受文档列表和嵌入对象，然后创建整体向量存储。

![](img/a79e11877c93e78d6e0286c3c4597b94_99.png)

现在可以使用向量存储查找与查询相似的文本。

![](img/a79e11877c93e78d6e0286c3c4597b94_101.png)

看看查询，请推荐一件带些遮挡的衬衫。

![](img/a79e11877c93e78d6e0286c3c4597b94_103.png)

如果使用向量存储的相似搜索方法并传入查询。

![](img/a79e11877c93e78d6e0286c3c4597b94_105.png)

将返回文档列表。

![](img/a79e11877c93e78d6e0286c3c4597b94_107.png)

![](img/a79e11877c93e78d6e0286c3c4597b94_108.png)

可以看到返回了4个文档，查看第一个。

![](img/a79e11877c93e78d6e0286c3c4597b94_110.png)

确实是一件关于遮挡的衬衫，如何使用这个来回答我们自己的文档问题，首先需要从这个向量存储创建检索器。

![](img/a79e11877c93e78d6e0286c3c4597b94_112.png)

检索器是一个通用接口，可以由任何接受查询并返回文档的方法支持。

![](img/a79e11877c93e78d6e0286c3c4597b94_114.png)

向量存储和嵌入是实现这一方法的一种，尽管有大量不同的方法，有些不那么先进，有些更先进，因为我们想进行文本生成并返回自然语言响应，将导入语言模型，将使用chat openai。



![](img/a79e11877c93e78d6e0286c3c4597b94_116.png)

如果手工操作，我们会将文档合并成单篇文本。

![](img/a79e11877c93e78d6e0286c3c4597b94_118.png)

像这样，将所有页面内容合并到变量中。

![](img/a79e11877c93e78d6e0286c3c4597b94_120.png)

然后传递这个变量或问题的变体，如请列出所有带有保护措施的搜索表格，用标记语言并总结每个到语言模型，如果打印出响应，可以看到我们得到了表格。



![](img/a79e11877c93e78d6e0286c3c4597b94_122.png)

正如我们所要求的，所有这些步骤都可以用lane chain链封装，所以这里可以创建检索。

![](img/a79e11877c93e78d6e0286c3c4597b94_124.png)

Qing，这做检索，然后在检索的文档上做问答以创建这样的链。

![](img/a79e11877c93e78d6e0286c3c4597b94_126.png)

将传入几个不同的东西，首先将传入语言模型，这将在最后用于文本生成。

![](img/a79e11877c93e78d6e0286c3c4597b94_128.png)

接下来将传入链类型，我们将使用stuff，这是最简单的方法，因为它只是把所有文档放入上下文并调用一次语言模型，还有一些其他方法可以使用来提问，回答将在最后提及，但不会详细查看，第三步传入检索器。

上面创建的检索器仅是获取文档的接口，将用于获取文档并将其传递给语言模型。

![](img/a79e11877c93e78d6e0286c3c4597b94_130.png)

最后设置verbose等于true。

![](img/a79e11877c93e78d6e0286c3c4597b94_132.png)

现在可以创建查询并运行链在此查询上，收到响应时，再次使用display和markdown工具显示。

![](img/a79e11877c93e78d6e0286c3c4597b94_134.png)

您可以暂停视频并尝试使用大量不同查询。

![](img/a79e11877c93e78d6e0286c3c4597b94_136.png)

这就是详细做法，但请记住，我们仍然可以很容易地，使用上面的单行代码，因此，这两件事等同于相同的结果，这是关于linchain有趣的部分，你可以在一行中完成，或者查看单独的项并将其分解为五个更详细的项。

五个更详细的项允许您设置关于正在发生什么的更多具体信息，单行代码易于开始，所以取决于你。

![](img/a79e11877c93e78d6e0286c3c4597b94_138.png)

关于你更喜欢如何前进，我们还可以在创建索引时自定义索引。

![](img/a79e11877c93e78d6e0286c3c4597b94_140.png)

所以如果你记得我们手动创建它，我们指定了嵌入。

![](img/a79e11877c93e78d6e0286c3c4597b94_142.png)

我们还可以在这里指定嵌入，因此，这给了我们控制嵌入本身如何创建的灵活性。

![](img/a79e11877c93e78d6e0286c3c4597b94_144.png)

我们还可以将向量存储器替换为不同类型的向量存储器。

![](img/a79e11877c93e78d6e0286c3c4597b94_146.png)

当你手动创建它时所做的相同级别的定制。

![](img/a79e11877c93e78d6e0286c3c4597b94_148.png)

在创建索引时也可用，我们在笔记本中使用stuff方法，stuff方法真的很棒，因为它很简单，你只需将所有内容放入一个提示中，并将其发送给语言模型以获取一个响应，所以很容易理解正在发生的事情。

它非常便宜并且工作得很好。

![](img/a79e11877c93e78d6e0286c3c4597b94_150.png)

但并不总是有效，好吧，所以如果你记得我们在笔记本中检索文档。

![](img/a79e11877c93e78d6e0286c3c4597b94_152.png)

我们只得到了四份文档，它们相对较小，但如果你想要做同样类型的问题。

![](img/a79e11877c93e78d6e0286c3c4597b94_154.png)

回答大量不同类型的块，我们可以使用几种不同的方法。

![](img/a79e11877c93e78d6e0286c3c4597b94_156.png)

第一个是mapreduce，基本上将所有块，与问题一起传递给语言模型，得到响应。

![](img/a79e11877c93e78d6e0286c3c4597b94_158.png)

然后使用另一个语言模型调用来总结所有个别响应到一个最终答案。

![](img/a79e11877c93e78d6e0286c3c4597b94_160.png)

这非常强大，因为它可以操作任何数量的文档，它也非常强大，因为你可以并行处理个别问题，但它确实需要更多的调用，所有文档视为独立。



![](img/a79e11877c93e78d6e0286c3c4597b94_162.png)

这不总是最想要的，精炼，再次遍历多文档的方法，实际上迭代进行，基于前文档的答案构建，非常适合组合信息，随时间构建答案，通常导致较长的答案，也不那么快，因为调用不再独立，依赖于前次调用的结果。

这意味着通常需要更长的时间，与MapReduce一样多的调用。

![](img/a79e11877c93e78d6e0286c3c4597b94_164.png)

MapRerank是一个有趣且更实验性的方法，对每个文档进行一次语言模型调用。

![](img/a79e11877c93e78d6e0286c3c4597b94_166.png)

并要求它返回一个分数，然后选择最高分，这依赖于语言模型知道分数应该是什么。

![](img/a79e11877c93e78d6e0286c3c4597b94_168.png)

所以经常需要告诉它，嘿，如果与文档相关，应该是高分，真正细化指示。

![](img/a79e11877c93e78d6e0286c3c4597b94_170.png)

类似于MapReduce，所有调用都是独立的，因此可以批量处理，相对较快，但再次进行了很多语言模型调用。



![](img/a79e11877c93e78d6e0286c3c4597b94_172.png)

所以会稍微贵一些，最常用的方法是stuff方法。

![](img/a79e11877c93e78d6e0286c3c4597b94_174.png)

我们在笔记本中用它把所有内容组合成一个文档，第二常用的是MapReduce方法，将这些块发送到语言模型。



![](img/a79e11877c93e78d6e0286c3c4597b94_176.png)

这些方法，Stuff，MapReduce精炼，以及WeRank也可以用于许多其他链条。

![](img/a79e11877c93e78d6e0286c3c4597b94_178.png)

不仅仅是问答，例如，MapReduce链的一个非常常见的用例是摘要，您有一个非常长的文档，并希望递归总结信息片段，这就是文档问答的全部，你可能已经注意到，我们这里的不同链条中有很多正在进行的事情。

所以在下一节。

![](img/a79e11877c93e78d6e0286c3c4597b94_180.png)