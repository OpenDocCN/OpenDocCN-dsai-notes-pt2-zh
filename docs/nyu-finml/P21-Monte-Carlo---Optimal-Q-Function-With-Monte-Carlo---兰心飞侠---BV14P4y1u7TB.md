# P21：蒙特卡洛 - 最优 Q 函数，使用蒙特卡洛 - 兰心飞侠 - BV14P4y1u7TB

现在，在我们找到最优动作 A t 星的系数 phi 和 t 后，我们转向寻找最优 Q 函数的系数 omega 和 t 的问题。为此，让我们再次回顾之前推导的贝尔曼最优性方程。为了找到系数 omega 和 t，我们考虑这个方程对于最优动作 A 星的情况。

而不是一般的动作 A t 的值。首先，让我们注意到，我们可以将这个方程解释为最优函数 Q t 星对奖励 R t 和折扣后的下一步最优 Q 函数在最优动作下的和进行回归，如第二个方程所示。如果我们对两者进行期望计算，就可以验证这两种表述是等价的。

第二个方程的两边。现在，为了将其用作回归以找到参数 omega 和 t，我们需要知道进入此表达式的即时奖励 R t。这很容易做，因为我们知道奖励的理论表达式。它由投资组合价值的增量给出，等于 gamma 乘以 pi sub t 加 1 减去 pi t，再减去一个风险溢价部分。

等于 lambda 乘以 pi t 的方差。如我们之前所见，奖励 R t 也可以更明确地写成时间 t 动作 A t 的二次函数。因此，当我们向后推算时，在反向递归过程中，一旦我们计算出最优动作 A t 星，我们将其代入奖励公式中以计算最优奖励。即评估在。

最优动作。因此，现在我们知道回归的因变量，它等于最优奖励和折扣后的下一步最优 Q 函数的和。这个表达式中的预测变量，即右侧的部分，是时间 t 的最优 Q 函数。现在，通过将 Q 星的扩展代入基函数。

系数 omega 和 t 成为此回归中的回归参数。为了找到它们，我们按照通常的回归方法，寻找使平方损失函数 F t 最小化的系数 omega 和 t，如此处所示。同样，因为这是一个关于系数 omega 和 t 的二次函数，所以该最小化过程可以通过半解析方法来执行。

我们引入另一个时间相关的矩阵对 CT，具有元素 Cmn 和向量 dt，具有元素 dn。矩阵 CT 的维度是 m 乘 m，而向量 dt 的长度是 m。回归问题中系数 omega 和 t 的解可以用向量形式表示，即矩阵 CT 的逆与向量 dt 的乘积。同样，因为我们这里处理的是。

在实际中，对于矩阵求逆，可能是个好主意通过在矩阵C中加入一个带有小正则化参数epsilon的单位矩阵来进行正则化处理，然后再进行矩阵求逆。解决方案就是将这个正则化后的矩阵的逆与dt相乘。这样就完成了在每个时间步所需的所有计算。我们有两个。

这种计算方法包含了两次线性回归：一次用来寻找最优行动，另一次用来找到最优Q函数在最优行动下的值。因此，对于t个时间步，我们将进行两次t次线性回归计算。我们需要这些计算来定价和对冲期权。现在我们来总结一下整个过程。

在反向递归中，我们从时间T-1开始，一直回溯到时间t=0。在每个时间步t，我们执行以下操作：首先计算矩阵AT和向量BT，然后计算系数phi和t，确定最优行动AT星。

然后我们使用这个值来计算与最优行动对应的即时奖励。接下来，我们计算矩阵CT和向量DT，并由此得出系数omega和t，并计算最优Q函数，在最优行动下评估。然后，计算出的最优Q函数将作为下一步最优Q的依据。

用于计算下一时刻t-1的反向递归的函数。当我们将此反向递归执行到时间t=0时，最后的最优行动将为我们提供期权的最优对冲，而最优价格将由最优Q函数的负值给出，最优行动作为第二个参数。因此，我们已为整个问题提供了完整的解决方案。

当动态条件已知时，我们可以使用这个解决方案。事实上，这个蒙特卡罗动态规划解法并不需要对模型动态的完全了解，只要能获取到基础股票的一部分样本数据即可。实现我们在此展示的动态规划蒙特卡罗反向递归所需的唯一附加条件就是。

这是关于风险厌恶参数lambda和股票漂移值mu的知识。在下周，我们将看到如何使用强化学习方法实现反向递归，这些方法不假设我们已经知道lambda。现在让我总结一下动态规划方法在期权定价中的表现的新示例。我们来看看具体内容。

如图所示。这个例子使用动态规划方法定价看跌期权，初始股票价格为$100，行使价为$100，这被称为平值期权或ATM期权。风险厌恶率lambda设置为0.001，股票波动率为15%，期权到期时间T为1年，股票漂移率取值为。

风险溢价为5%，无风险利率为3%。现在，左上图显示了蒙特卡罗模拟中股票价格的10个部分的随机波动。右上图显示了相应的状态变量Xt的值。如预期的那样，状态变量Xt的演变没有显示出漂移。你也可以看到，对于股票价格的某一特定路径（如左侧所示）。

尽管ST存在漂移现象，但这种现象并不十分明显，这只是一个视觉效果。ST的路径确实有漂移，而Xt的路径则没有。中间行的左侧图显示了在这些路径上获得的最优动作，右侧图则显示了相应的复制投资组合的值。最后，底行左侧的图显示了获得的奖励。

从采取最优动作所获得的回报，右侧图显示了最优Q函数。正如你所看到的，它在时间0时收敛到4.9的值，而黑色曲线表示价格为4.53。你可以通过将风险厌恶率调小、对冲频率调大来检查是否收敛到黑色曲线所表示的期权价格。事实上，这将成为你本周作业的一部分，连同这个动态规划方案的实际实现。

本周的内容就到这里，但显然在结束之前我们先做一个简短的停留，回答一些问题，下周再见。

![](img/f38793c02c794ecf9ccd0bc133d65304_1.png)

[BLANK_AUDIO]。

![](img/f38793c02c794ecf9ccd0bc133d65304_3.png)
